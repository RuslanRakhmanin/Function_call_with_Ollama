# Function Calling with Local Models & LangChain - Ollama, Llama3

## Introduction

In this repo I tried to implement a function calling example with Ollama and Llama3.
As I found in the process, Ollama does not support function calling natively.
At least it did not in the version 0.1.41.
I started with the [video by Sam Witteveen](https://youtu.be/Ss_GdU0KqE0),
where he demonstrated how to implement function calling with Ollama and LangChain.
In this video Sam uses the LangChain Experimental library to implement function calling generated by Ollama.
Unfortunately, this example covers only the step where Ollama requests a function call.
There is no response to Ollama and step after when Ollama generates a response with additional data from the function call.
So, this implementation of function calling is not as complete as OpenAI documentation shows in the [example](https://platform.openai.com/docs/guides/function-calling).
I tried to make it as complete as possible.

## Versions

- Ollama: 0.1.41
- Llama3: llama3:8b-instruct-q8_0
- LangChain Experimental 0.0.60

## Try 1. Current weather in a given location

You can find the code [here](ollama_Llama3_function_current_weather.py).

I took the code from the [video by Sam Witteveen](https://youtu.be/Ss_GdU0KqE0) as a starting point. You can find the original file [here](https://github.com/samwit/agent_tutorials/blob/main/ollama_agents/llama3_local/llama3_ollama_functions.py) or a local copy [here](Examples/llama3_ollama_functions.py).

This is what was shown in the video by Sam:

```Mermaid
sequenceDiagram
    Agent ->> Ollama: original prompt
    Ollama -->> Agent: function call
```

This is what I can see in the [OpenAI documentation about function calling](https://platform.openai.com/docs/guides/function-calling):

```Mermaid
sequenceDiagram
    Agent ->> OpenAI: original prompt
    OpenAI -->> Agent: functions call
    Agent ->> OpenAI: functions response
    OpenAI -->> Agent: final answer
```

To make the Ollama example follow the OpenAI documentation, I made some changes in the code:

- I have changed the DEFAULT_SYSTEM_TEMPLATE because the original one makes LLM always respond with a function call. It is literally said in the original prompt: `You must always select one of the above tools and respond with only a JSON object`

- The AI temperature was set to 0. It makes the LLM answers constant for the same prompt.

- Langchain has only 3 types of messages for Ollama: HumanMessage, AIMessage, SystemMessage.
 It is better to have here a ToolMessage or a FunctionMessage.
  But it is what it is.
  So the response after a function call was made like HumanMessage.
  The response was added to the top of the message history. Otherwise, LLama3 returned a function call.

Fun fact. In my prompt the word "Respond" should be written with the first letter capitalized. Otherwise, AI returns a function call for the second invoke.

The final answer depends on the original prompt. For example, the prompt `what is the weather in Singapore? Give a short answer.` confuses llama3:8b-instruct-q8_0.
 On the other hand, the prompt `Give a short answer. what is the weather in Singapore?` works well.

 Quantized version llama3:8b-instruct-q5_K_S performs even worse than llama3:8b-instruct-q8_0. It answered correctly only for 1 prompt from 3.
 It is better to use the full version of Llama3 8b.

The final conversation between Agent and Ollama.Llama3 is shown below:

```Mermaid
sequenceDiagram
    Agent ->> Ollama.Llama3: "Give a short answer. what is the weather in Singapore?"
    Ollama.Llama3 -->> Agent: "tool_calls=[{'name': 'get_current_weather', 'args': {'location': 'Singapore', 'unit': 'celsius'}"
    Agent ->> Ollama.Llama3: "message 1: "{"location": "Singapore", "temperature": "26", "unit": "celsius"}" <br> message 2: " Give a short answer. what is the weather in Singapore?""
    Ollama.Llama3 -->> Agent: "It's warm and sunny in Singapore, with a temperature of 26 degrees Celsius!"
```

## Try 2. Calculator tool call

The source code is available [here](ollama_llama3_function_calculator.py).

```text
TODO
```

## Try 3. Multiple functions call

```text
TODO
```

## Links

### Examples of function calling with Ollama and LangChain

Video by Sam Witteveen: [Function Calling with Local Models & LangChain - Ollama, Llama3 & Phi-3](https://youtu.be/Ss_GdU0KqE0)

Repo for the video: https://github.com/samwit/agent_tutorials/tree/main/ollama_agents/llama3_local

Copies of the source code for the video are available [here](Examples).

### Function Calling in Ollama with raw requests

Video by Matt Williams: [Function Calling in Ollama vs OpenAI](https://youtu.be/RXDWkiuXtG0)

In this video Matt focuses on getting structured output from Ollama in JSON.
He ignores the OpenAI API capabilities to ask the user side for additional information as a function call and use this information for the answer generation.
Maybe OpenAI documentation did not cover it well at that time.

The source code for this video is available [here](Examples/fc.py).

### Function calling with OpenAI API

[OpenAI documentation. Function calling](https://platform.openai.com/docs/guides/function-calling)

You can find the source code from this documentation [here](Examples/openAI_multiple_function_calls.py).

### Tools usage (function calling) for Anthropic

[Tool use (function calling)](https://docs.anthropic.com/en/docs/tool-use)

[Tool use examples](https://docs.anthropic.com/en/docs/tool-use-examples)

[Example. Using a Calculator Tool with Claude](https://github.com/anthropics/anthropic-cookbook/blob/main/tool%5Fuse/calculator%5Ftool.ipynb)
